<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Masking Sheet</title>
<!-- icons & libs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  :root{ --blue:#2b6ea3; --muted:#6d6d6d; --bg:#f4f6f8; --panel:#fff; }
  body{ font-family:Segoe UI, Arial, sans-serif; background:var(--bg); margin:18px; color:#222; }
  :root {--purple: #9c4aa7;--purple-dark: #7f3b8b;--accent-yellow: #f6c21e;--btn-blue: #1f78a3;--btn-orange: #f2a33c;--card-border: #1080b2;--header-height: 50px;--radius: 6px;font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}
  body {margin: 0;background: #fff;color: #333;padding: 5px 12px;}
  .topbar {background: linear-gradient(180deg, var(--purple) 0%, #8d4d91 100%);color: white;border-radius: 6px;display: flex;align-items: center;height: var(--header-height);padding: 0 9px;box-sizing: border-box;border: 2px solid rgba(0, 0, 0, 0.05);box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);}
  .top-left, .top-center, .top-right {display: flex;align-items: center;gap: 12px;}
  .top-left {min-width: 260px;}
  .top-center {flex: 1;justify-content: center;}
  .top-right {min-width: 320px;justify-content: flex-end;}
  .company {font-weight: 400;font-size: 20px;padding: 0 18px;border-right: 2px solid rgba(255, 255, 255, 0.12);height: 100%;display: flex;align-items: center;}
  .erp-menu {padding: 0 16px;font-weight: 300;height: 100%;display: flex;align-items: center;margin-left: 8px;}
  .menu-title {color: var(--accent-yellow);font-size: 22px;font-weight: 500;letter-spacing: 0.6px;}
  .search-box {display: flex;align-items: center;background: rgba(255, 255, 255, 0.95);padding: 6px 8px;border-radius: 4px;margin-right: 12px;height: 34px;}
  .search-box input {border: 0;outline: 0;width: 140px;font-size: 14px;}
  .search-box button {border: 0;background: transparent;padding: 0 6px;cursor: pointer;}
  .user-area {font-size: 14px;font-weight: 500;}
  .change-user {font-size: 14px;font-weight: 300;text-decoration: underline;cursor: pointer;}
  .change-user:hover {color: #ddd;}
  .wrap{ max-width:1200px; margin:10px auto; }
  .panel{ background:var(--panel); border:2px solid var(--blue); border-radius:8px; padding:14px; box-sizing:border-box; width:100%; margin-bottom:16px; }
  h2{ margin:4px 0 12px 0; color:var(--blue); }
  .form-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:12px; }
  label{ display:block; font-weight:700; color:var(--blue); font-size:13px; margin-bottom:6px; }
  input[type="text"], input[type="date"], input[type="number"], select { padding:8px 10px; border-radius:6px; border:1px solid #cfcfcf; width:100%; box-sizing:border-box; }
  textarea{ width:100%; padding:8px; border-radius:6px; border:1px solid #cfcfcf; box-sizing:border-box; resize:vertical; }
  .controls{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center; }
  .btn{ display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:700; border:0; }
  .btn.primary{ background:var(--blue); color:white; } .btn.warn{ background:#e55353; color:white; } .btn.ghost{ background:white; border:1px solid var(--blue); color:var(--blue); }
  .small{ font-size:13px; color:var(--muted); }
  #entriesContainer{ margin-top:12px; border:1px dashed #dbeaf5; padding:10px; border-radius:6px; background:#fbfdff; max-height:420px; overflow:auto; }
  .entry-row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .entry-row input, .entry-row select { padding:6px; font-size:13px; }
  .very-small { width:200px; } .small { width:260px; }
  table{ width:100%; border-collapse:collapse; margin-top:12px; }
  th, td{ border:1px solid #e1eefb; padding:8px; text-align:left; font-size:13px; vertical-align:middle; }
  th{ background:#f4fbff; color:var(--blue); font-weight:800; }
  #revisionTableTemplate {width: 100%;border-collapse: collapse;font-family: Arial, sans-serif;border: 1px solid #333;}
  #revisionTableTemplate td {border: 1px solid #666;padding: 8px 10px;text-align: left;}
  .rev-history-header td {background-color: #eee;font-weight: bold;color: #333;text-align: center;}
  #revisionTableTemplate tbody tr:hover {background-color: #f5f5f5;}
  @media (max-width:980px){ .form-grid{ grid-template-columns: repeat(2, 1fr); } .entry-row{ flex-wrap:wrap; } }
  @media (max-width:600px){ .form-grid{ grid-template-columns: 1fr; } .entry-row{ flex-direction:column; align-items:stretch; } }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="top-left">
      <div class="company">SRI SAI</div>
      <div class="erp-menu">Plot No-71</div>
    </div>
    <div class="top-center"><div class="menu-title">Masking Sheet</div></div>
    <div class="top-right">
      <div class="search-box" title="Search menu">
        <input id="menuSearch" type="search" placeholder="Search" aria-label="Menu search">
        <button id="menuSearchBtn" aria-label="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
      </div>
      <div class="user-area">(User : store)</div>
      <div class="change-user">Change User</div>
    </div>
  </header>
<div class="wrap">
  <div class="panel" id="entryPanel">
    <h2>Masking Sheet</h2>
    <div style="font-weight:700; color:var(--blue); margin-bottom:8px;">Header</div>
    <div class="form-grid" id="headerForm">
        <div>
        <label>Department</label>
        <input id="hdr_department" type="text" placeholder="Department">
      </div>
      <div>
        <label>Date</label>
        <input id="hdr_date" type="date" readonly>
      </div>
      <div>
        <label>Item Description</label>
        <input id="hdr_item_description" type="text" placeholder="Item Description">
      </div>
    </div>
    <div class="controls" style="margin-top:8px;">
      <button class="btn ghost" id="addRowBtn"><i class="fa-solid fa-plus"></i> Add Row</button>
      <button class="btn ghost" id="clearRowsBtn"><i class="fa-solid fa-trash"></i> Clear Rows</button>
      <div style="flex:1"></div>
      <button class="btn primary" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Save All Rows</button>
      <button class="btn ghost" id="previewBtn"><i class="fa-regular fa-eye"></i> Preview</button>
    </div>
    <div id="entriesContainer" aria-live="polite"></div>
  </div>
  <div class="panel" style="margin-top:16px;">
    <h2>Download & Export</h2>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <label style="font-weight:700; color:var(--blue);">From:</label>
      <input type="date" id="fromDate" />
      <label style="font-weight:700; color:var(--blue);">To:</label>
      <input type="date" id="toDate" />
      <button class="btn ghost" id="loadBtn">Load Data</button>
      <button class="btn ghost" id="exportExcel">Export Excel</button>
      <button class="btn ghost" id="exportPDF">Export PDF</button>
      <div style="flex:1"></div>
    </div>
    <div id="monthResult" style="overflow-x:auto; max-width:100%; margin-top:12px;">
      <div class="small">No month loaded.</div>
    </div>
  </div>
  <!---------------------------------------------------->
   <div id="pdfTemplate" style="display: none;">
    <div class="form-container" id="formContainer">
        <header>
            <div class="header-left">
                <div class="logo-placeholder">
                    <img src="/static/logo.png" alt="Company Logo" style="height: 58px; width: 58px; vertical-align: middle;">
                </div>
                <h1>SRI SAI MARKERS & ENGRAVERS</h1>
                <h2>MASKING SHEET</h2>
            </div>
            <div class="header-right">
                <p>Format No:- F-SSME-52</p>
                <p>Revision No:- 02</p>
                <p>Issue Date:- 31.10.2017</p>
                <p>Rev Date:-08.07.2022</p>
            </div>
        </header>
        
        <table class="production-sheet" id="productionSheet">
            <colgroup>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
            </colgroup>
            <thead>
                <tr>
                    <td rowspan="2">Department</td>
                    <td rowspan="2">Date</td>
                    <td rowspan="2">Item Description</td>
                    <td rowspan="2">Qty/Lot</td>
                    <td rowspan="2">Start Time</td>
                    <td rowspan="2">End Time</td> 
                    <td rowspan="2">OK Qty After Masking</td>
                    <td rowspan="2">Reject Qty</td>
                    <td rowspan="2">Defect</td>
                    <td rowspan="2">Judgement</td>
                    <td rowspan="2">Prepared By</td>
                    <td rowspan="2">Verified By</td>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        </div>
    <div id="revisionHistoryTemplate">
      <table id="revisionTableTemplate">
        <thead>
          <tr class="rev-history-header">
            <td>S No. </td>
            <td>Amendment. </td>
            <td>Rev No. </td>
            <td>Rev Date </td>
          </tr>
        </thead>
        <tbody>
          <tr class="rev-histroy">
            <td>1</td>
            <td>Add Judgement Criteria</td>
            <td>01</td>
            <td>14.01.2019</td>
          </tr>
          <tr class="rev-histroy">
            <td>2</td>
            <td>Change Format Number</td>
            <td>02</td>
            <td>08.07.2022</td>
          </tr>
        </tbody>
      </table>
      </div>
    </div>
 <!--------------------------->
</div>
<script>
const STORAGE_KEY = 'masking_records_v2_fixed';
const entriesContainer = document.getElementById('entriesContainer');
const addRowBtn = document.getElementById('addRowBtn');
const clearRowsBtn = document.getElementById('clearRowsBtn');
const saveBtn = document.getElementById('saveBtn');
const previewBtn = document.getElementById('previewBtn');
const loadBtn = document.getElementById('loadBtn');
const exportExcelBtn = document.getElementById('exportExcel');
const exportPDFBtn = document.getElementById('exportPDF');
const menuSearch = document.getElementById('menuSearch');
const menuSearchBtn = document.getElementById('menuSearchBtn');
const rowColumns = [
  'lot_qty','start_time','end_time','ok_qty_after_masking',
  'reject_qty','defect','judgement','prepared_by','verify_by'
];
function makeInput(type, cls, value, placeholder, options){
  let el;
  if (type === 'select'){
    el = document.createElement('select');
    (options||[]).forEach(opt => { const o = document.createElement('option'); o.value = opt.value; o.text = opt.label; el.appendChild(o); });
    el.value = value || '';
  } else {
    el = document.createElement('input'); el.type = type || 'text'; if (value !== undefined && value !== null) el.value = value; if (placeholder) el.placeholder = placeholder;
  }
  if (cls) el.classList.add(cls);
  el.addEventListener('keydown', navKeyHandler);
  return el;
}
function createRowElement(prefill = {}){
  const row = document.createElement('div'); row.className = 'entry-row';
  row.appendChild(makeInput('number','very-small', prefill['lot_qty'] ?? '', 'Lot Qty'));
  row.appendChild(makeInput('time','very-small', prefill['start_time'] ?? '', 'Start Time'));
  row.appendChild(makeInput('time','very-small', prefill['end_time'] ?? '', 'End Time'));
  row.appendChild(makeInput('number','small', prefill['ok_qty_after_masking'] ?? '', 'OK Qty After Masking'));
  row.appendChild(makeInput('number','small', prefill['reject_qty'] ?? '', 'Reject Qty'));
  row.appendChild(makeInput('number','small', prefill['defect'] ?? '', 'Defect'));
  const sel = makeInput('select','small', prefill['judgement'] ?? '', 'judgement', [{value:'',label:''},{value:'OK',label:'OK'},{value:'NG',label:'NG'}]);
  row.appendChild(sel);
  row.appendChild(makeInput('text','small', prefill['prepared_by'] ?? '', 'Prepared By'));
  row.appendChild(makeInput('text','small', prefill['verify_by'] ?? '', 'Verify By'));
  const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.className='btn warn action-btn'; delBtn.title='Remove row'; delBtn.innerHTML='<i class="fa-solid fa-trash"></i>';
  delBtn.addEventListener('click', () => { row.remove(); updateNavInputs(); });
  row.appendChild(delBtn);
  return row;
}
function addRow(prefill = {}){ const el = createRowElement(prefill); entriesContainer.appendChild(el); updateNavInputs(); const inputs = el.querySelectorAll('input, select'); if (inputs[0]) inputs[0].focus(); }
addRow();
addRowBtn.addEventListener('click', () => addRow());
clearRowsBtn.addEventListener('click', () => { if (!confirm('Clear all entry rows?')) return; entriesContainer.innerHTML = ''; addRow(); });
function collectNavInputs(){ return Array.from(entriesContainer.querySelectorAll('input, select')); }
function navKeyHandler(e){ const inputs = collectNavInputs(); const idx = inputs.indexOf(e.target); if (e.key === 'ArrowRight'){ e.preventDefault(); if (idx>=0 && idx < inputs.length-1) inputs[idx+1].focus(); } else if (e.key === 'ArrowLeft'){ e.preventDefault(); if (idx>0) inputs[idx-1].focus(); } else if (e.key === 'Enter'){ e.preventDefault(); if (idx>=0 && idx < inputs.length-1) inputs[idx+1].focus(); } }
function updateNavInputs(){ const inputs = collectNavInputs(); inputs.forEach(inp => { inp.removeEventListener('keydown', navKeyHandler); inp.addEventListener('keydown', navKeyHandler); }); }
window.updateNavInputs = updateNavInputs;
function readEntriesFromStorage(){ const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return []; try { return JSON.parse(raw) || []; } catch(e){ return []; } }
function writeEntriesToStorage(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
saveBtn.addEventListener('click', () => {
  const headerDepartment = document.getElementById('hdr_department').value || '';
  const headerDate = document.getElementById('hdr_date').value;
  if (!headerDate) { alert('Select Date in header before saving.'); return; }
  const headerItemDescription = document.getElementById('hdr_item_description').value || '';
  const rows = Array.from(entriesContainer.querySelectorAll('.entry-row'));
  if (!rows.length) { alert('No rows to save.'); return; }
  const toSave = [];
  rows.forEach(r => {
    const inputs = Array.from(r.querySelectorAll('input, select'));
    const values = {};
    let i = 0;
    values['lot_qty'] = parseNumber(inputs[i++].value);
    values['start_time'] = inputs[i++].value;
    values['end_time'] = inputs[i++].value;
    values['ok_qty_after_masking'] = parseNumber(inputs[i++].value);
    values['reject_qty'] = parseNumber(inputs[i++].value);
    values['defect'] = parseNumber(inputs[i++].value);
    values['judgement'] = inputs[i++].value || '';
    values['prepared_by'] = inputs[i++].value || '';
    values['verify_by'] = inputs[i++].value || '';
    const entry = { department: headerDepartment, date: headerDate, item_description: headerItemDescription, ...values, savedAt: new Date().toISOString() };
    toSave.push(entry);
  });
  const stored = readEntriesFromStorage(); Array.prototype.push.apply(stored, toSave); writeEntriesToStorage(stored);
  alert(`Saved ${toSave.length} row(s).`);
});
function parseNumber(v){ if (v === '' || v === null || v === undefined) return ''; const n = Number(v); return Number.isFinite(n) ? n : ''; }
previewBtn.addEventListener('click', () => {
  const rows = Array.from(entriesContainer.querySelectorAll('.entry-row'));
  if (!rows.length) { alert('No rows to preview'); return; }
  const lines = [];
  rows.forEach((r, idx) => { const inputs = Array.from(r.querySelectorAll('input, select')); const arr = inputs.map(inp => inp.value); lines.push(`${idx+1}. ${arr.join(' | ')}`); });
  alert(lines.join('\n\n'));
});
async function saveAllRowsToAPI() {
    const headerDepartment = document.getElementById('hdr_department').value;
    const headerDate = document.getElementById('hdr_date').value;
    if (!headerDate) { alert('Select Date in header before saving.'); return; }
    const headerItem = document.getElementById('hdr_item_description').value || '';
    const rows = Array.from(entriesContainer.querySelectorAll('.entry-row'));
    if (!rows.length) { alert('No rows to save.'); return; }
    for (let r of rows) {
        const inputs = Array.from(r.querySelectorAll('input, select'));
        let i = 0;
        const payload = {
            department: headerDepartment,
            date: headerDate,
            item_description: headerItem,
            lot_qty: parseInt(inputs[i++].value),
            start_time: inputs[i++].value || null,
            end_time: inputs[i++].value || null,
            ok_qty_after_masking: parseInt(inputs[i++].value),
            reject_qty: parseInt(inputs[i++].value),
            defect: parseInt(inputs[i++].value),
            judgement: inputs[i++].value,
            prepared_by: inputs[i++].value || '',
            verify_by: inputs[i++].value || '',
        };
        
        if(!payload.department || !payload.item_description || !payload.lot_qty || !payload.start_time || !payload.end_time || !payload.ok_qty_after_masking || !payload.judgement){
            alert('You are not filling proper data.');
            return;
        }
        try {
            let res = await fetch("/api/masking-entries/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error("Error saving row");
        } catch (err) {
            console.error("Save failed:", err);
            alert("Error while saving data.");
            return;
        }
    }
    alert("All rows saved to server!");
    entriesContainer.innerHTML = '';
    addRow(); 
}
saveBtn.addEventListener('click', saveAllRowsToAPI);
/* Month / Table rendering */
function buildTableHtml(entries){
  if (!entries.length) return '<div class="small">No records.</div>';
  let html = '<table id="dataTable"><thead><tr>';
  const heads = [
    'Department','Date','Item Description','Lot Qty','Start Time','End Time','OK Qty After Masking',
    'Reject Qty','Defect','Judgement','Prepared By','Verify By',
  ];
  heads.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
  html += '</tr></thead><tbody>';
  
  entries.forEach(en => {
    html += '<tr>';
    const row = [
      en.department || '',  
      en.date || '',        
      en.item_description || '',        
      en.lot_qty || '',
      en.start_time || '',
      en.end_time || '',
      en.ok_qty_after_masking || '',
      en.reject_qty || '',
      en.defect || '',
      en.judgement || '',
      en.prepared_by || '',
      en.verify_by || '',
    ];
    row.forEach(c => html += `<td>${escapeHtml(c)}</td>`);
  });

  html += '</tbody></table>';
  return html;
}
async function loadDataFromAPI() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const partSearchQuery = document.getElementById('menuSearch').value.trim().toLowerCase(); 
    if (!fromDate || !toDate) { 
        alert("Please select both From and To dates"); 
        return; 
    }
    try {
        let res = await fetch("/api/masking-entries/");
        if (!res.ok) throw new Error("Failed to fetch data from API");
        let data = await res.json();
        let filtered = data.filter(e => {
            const isInDateRange = e.date >= fromDate && e.date <= toDate;
            const itemDescMatch = !partSearchQuery || (e.item_description && e.item_description.toLowerCase().includes(partSearchQuery));
            return isInDateRange && itemDescMatch;
        });
        document.getElementById('monthResult').innerHTML = buildTableHtml(filtered);
        if (partSearchQuery) menuSearch.dispatchEvent(new Event('keyup'));
    } catch (err) {
        console.error("Load failed:", err);
        alert("Error while loading data. Check console for details.");
    }
}
loadBtn.addEventListener('click', loadDataFromAPI);
/* Attach search functionality (menuSearch) */
if (menuSearch){ menuSearch.addEventListener('keyup', function(){ const q = this.value.toLowerCase(); const table = document.getElementById('dataTable'); if (!table) return; const rows = table.querySelectorAll('tbody tr'); rows.forEach(r => { const text = r.innerText.toLowerCase(); r.style.display = text.includes(q) ? '' : 'none'; }); }); }
if (menuSearchBtn){ menuSearchBtn.addEventListener('click', function(){ if (menuSearch) menuSearch.dispatchEvent(new Event('keyup')); }); }
/* Export handlers for range */
exportExcelBtn.addEventListener('click', () => {
    const fromDate = document.getElementById('fromDate').value; 
    const toDate = document.getElementById('toDate').value; 
    if (!fromDate || !toDate) { alert('Select From & To dates'); return; }
    loadDataFromAPI().then(() => {
        const dataTable = document.getElementById("dataTable");
        if (!dataTable || dataTable.querySelectorAll('tbody tr').length === 0) { 
            alert('No records loaded for export.'); 
            return; 
        }
        exportEntriesToExcel(null, `${fromDate}_to_${toDate}`);
    }).catch(err => {
        console.error('Error during load for export:', err);
    });
});
exportPDFBtn.addEventListener('click', () => {
    const fromDate = document.getElementById('fromDate').value; 
    const toDate = document.getElementById('toDate').value; 
    if (!fromDate || !toDate) { alert('Select From & To dates'); return; }
    loadDataFromAPI().then(() => {
        const dataTable = document.getElementById("dataTable");
        if (!dataTable || dataTable.querySelectorAll('tbody tr').length === 0) { 
            alert('No records loaded for PDF export.'); 
            return; 
        }
        exportEntriesToPDF(`${fromDate}_to_${toDate}`);
    }).catch(err => {
        console.error('Error during load for PDF export:', err);
    });
});
function exportEntriesToExcel(entries, filenamePrefix) {
    const table = document.getElementById("dataTable");
    if (!table) {
        return alert("No loaded data table available to export. Please load data first.");
    }
    const wb = XLSX.utils.book_new();
    const aoa_data = XLSX.utils.sheet_to_json(
        XLSX.utils.table_to_sheet(table, { raw: false, header: 1 }), 
        { header: 1 }
    );
    if (!aoa_data || aoa_data.length === 0) {
        return alert("Failed to extract data from the table.");
    }
    const columnHeaders = aoa_data[0];
    const dataRows = aoa_data.slice(1);

    
    const ws = XLSX.utils.json_to_sheet([]); 
    const final_content = [
        ["Sri Sai Markers & Engravers"], 
        ["Masking Sheet"],   
        [],                             
        columnHeaders,
        ...dataRows
    ];
    XLSX.utils.sheet_add_aoa(ws, final_content, { origin: "A1" });
    XLSX.utils.book_append_sheet(wb, ws, "Masking Records");
    XLSX.writeFile(wb, `MaskingRecords.xlsx`);
}
 async function exportEntriesToPDF(filenamePrefix) {
            const { jsPDF } = window.jspdf;
            const dataTable = document.getElementById("dataTable");
            const mainTemplateTable = document.getElementById("productionSheet");
            const revisionTableElement = document.getElementById("revisionTableTemplate"); 
            if (!mainTemplateTable || !dataTable || !revisionTableElement) {
                console.error("Required HTML elements are missing: #productionSheet, #dataTable, or #revisionTableTemplate.");
                return alert("Error: PDF are not generated before Clicking the Load Data Button.");
            }
            const dataBodyRows = Array.from(dataTable.querySelectorAll("tbody tr"));
            const templateTbody = mainTemplateTable.querySelector('tbody');
            templateTbody.innerHTML = '';
            dataBodyRows.forEach(row => {
                templateTbody.appendChild(row.cloneNode(true));
            });
            const pdf = new jsPDF("l", "mm", "a4");
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 2;
            const boxX = margin;
            const boxWidth = pageWidth - margin * 2;
            const HEADER_HEIGHT = 25; 
            const FOOTER_REVISION_HEIGHT = 40; 
            const logoPromise = new Promise((resolve) => {
                const logo = new Image();
                logo.src = "/static/logo.png";
                logo.onerror = () => resolve(null);
                logo.onload = () => resolve(logo);
                if (logo.complete) resolve(logo);
            });
            const logo = await logoPromise;
            const addCustomHeader = () => {
                pdf.setDrawColor(0);
                pdf.setLineWidth(0.5);
                pdf.rect(boxX, margin, boxWidth, pageHeight - margin * 2);
                if (logo) {
                    pdf.addImage(logo, "PNG", boxX + 5, margin + 2, 18, 18);
                }
                pdf.setFontSize(15);
                pdf.setFont("helvetica", "bold");
                pdf.text("SRI SAI MARKERS & ENGRAVERS", pageWidth / 2, margin + 8, { align: "center" });
                pdf.setFontSize(9);
                pdf.setFont("helvetica", "bold");
                pdf.text("Masking SHEET", pageWidth / 2, margin + 16, { align: "center" });
                pdf.setFontSize(7);
                pdf.setFont("helvetica", "bold");
                pdf.text(`Format No.:- F-SSME-52`, boxX + boxWidth - 2, margin + 6, { align: "right" });
                pdf.text(`Revision No.:- 02`, boxX + boxWidth - 2, margin + 10, { align: "right" });
                pdf.text(`Issue Date :- 31.10.2017`, boxX + boxWidth - 2, margin + 14, { align: "right" });
                pdf.text(`Rev Date :- 08.07.2022`, boxX + boxWidth - 2, margin + 18, { align: "right" });
            };
            const addRevisionFooter = () => {
                const footerY = pageHeight - FOOTER_REVISION_HEIGHT; 
                pdf.autoTable({
                    html: revisionTableElement,
                    startY: footerY,
                    styles: { fontSize: 7, lineColor: [0, 0, 0], lineWidth: 0.1 },
                    headStyles: { fillColor: [255, 255, 255], textColor: 0, fontStyle: 'bold' },
                    bodyStyles: { minCellHeight: 6, valign: 'middle' },
                    theme: "grid",
                    margin: { left: boxX + 1, right: margin + 1 }, 
                    didDrawPage: () => {} 
                });
            };
            pdf.autoTable({
                html: mainTemplateTable,
                startY: margin + HEADER_HEIGHT,
                styles: { fontSize: 7, lineColor: [0, 0, 0], lineWidth: 0.1 },
                headStyles: { fillColor: [43, 110, 163], textColor: 255, fontStyle: 'bold' },
                bodyStyles: { minCellHeight: 6 },
                theme: "grid",
                didDrawPage: (data) => {
                    addCustomHeader();
                    addRevisionFooter();
                },
                pageBreak: 'auto',
                margin: { bottom: 0, left: boxX + 1, right: margin + 1 }
            });
            templateTbody.innerHTML = '';
            pdf.save(`MaskingRecords.pdf`);
        }
function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
(function init(){ 
 const now = new Date(); 
 const today = now.toISOString().slice(0,10);
 const hdrDateEl = document.getElementById('hdr_date');
 if (hdrDateEl) hdrDateEl.value = today; 
 const mm = today.slice(0,7);
 const monthPicker = document.getElementById('monthPicker'); 
 if (monthPicker) monthPicker.value = mm; 
 const from = new Date(now.getFullYear(), now.getMonth(), 1); 
 const to = new Date(now.getFullYear(), now.getMonth()+1, 0); 
 document.getElementById('fromDate').value = from.toISOString().slice(0,10); 
 document.getElementById('toDate').value = to.toISOString().slice(0,10); 
 //try { getLocation(); } catch(e){ console.warn('getLocation() failed to start', e); }
 updateNavInputs(); 
})();
</script>
</body>
</html>