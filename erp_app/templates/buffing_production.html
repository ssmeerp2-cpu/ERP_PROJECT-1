<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Buffing Production Sheet</title>
<!-- icons & libs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  :root{ --blue:#2b6ea3; --muted:#6d6d6d; --bg:#f4f6f8; --panel:#fff; }
  body{ font-family:Segoe UI, Arial, sans-serif; background:var(--bg); margin:18px; color:#222; }
  :root {--purple: #9c4aa7;--purple-dark: #7f3b8b;--accent-yellow: #f6c21e;--btn-blue: #1f78a3;--btn-orange: #f2a33c;--card-border: #1080b2;--header-height: 50px;--radius: 6px;font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}
  body {margin: 0;background: #fff;color: #333;padding: 5px 12px;}
  .topbar {background: linear-gradient(180deg, var(--purple) 0%, #8d4d91 100%);color: white;border-radius: 6px;display: flex;align-items: center;height: var(--header-height);padding: 0 9px;box-sizing: border-box;border: 2px solid rgba(0, 0, 0, 0.05);box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);}
  .top-left, .top-center, .top-right {display: flex;align-items: center;gap: 12px;}
  .top-left {min-width: 260px;}
  .top-center {flex: 1;justify-content: center;}
  .top-right {min-width: 320px;justify-content: flex-end;}
  .company {font-weight: 400;font-size: 20px;padding: 0 18px;border-right: 2px solid rgba(255, 255, 255, 0.12);height: 100%;display: flex;align-items: center;}
  .erp-menu {padding: 0 16px;font-weight: 300;height: 100%;display: flex;align-items: center;margin-left: 8px;}
  .menu-title {color: var(--accent-yellow);font-size: 22px;font-weight: 500;letter-spacing: 0.6px;}
  .search-box {display: flex;align-items: center;background: rgba(255, 255, 255, 0.95);padding: 6px 8px;border-radius: 4px;margin-right: 12px;height: 34px;}
  .search-box input {border: 0;outline: 0;width: 140px;font-size: 14px;}
  .search-box button {border: 0;background: transparent;padding: 0 6px;cursor: pointer;}
  .user-area {font-size: 14px;font-weight: 500;}
  .change-user {font-size: 14px;font-weight: 300;text-decoration: underline;cursor: pointer;}
  .change-user:hover {color: #ddd;}
  .wrap{ max-width:1200px; margin:10px auto; }
  .panel{ background:var(--panel); border:2px solid var(--blue); border-radius:8px; padding:14px; box-sizing:border-box; width:100%; margin-bottom:16px; }
  h2{ margin:4px 0 12px 0; color:var(--blue); }
  .form-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:12px; }
  label{ display:block; font-weight:700; color:var(--blue); font-size:13px; margin-bottom:6px; }
  input[type="text"], input[type="date"], input[type="number"], select { padding:8px 10px; border-radius:6px; border:1px solid #cfcfcf; width:100%; box-sizing:border-box; }
  textarea{ width:100%; padding:8px; border-radius:6px; border:1px solid #cfcfcf; box-sizing:border-box; resize:vertical; }
  .controls{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center; }
  .btn{ display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:700; border:0; }
  .btn.primary{ background:var(--blue); color:white; } .btn.warn{ background:#e55353; color:white; } .btn.ghost{ background:white; border:1px solid var(--blue); color:var(--blue); }
  .small{ font-size:13px; color:var(--muted); }
  #entriesContainer{ margin-top:12px; border:1px dashed #dbeaf5; padding:10px; border-radius:6px; background:#fbfdff; max-height:420px; overflow:auto; }
  .entry-row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .entry-row input, .entry-row select { padding:6px; font-size:13px; }
  .very-small { width:200px; } .small { width:260px; }
  table{ width:100%; border-collapse:collapse; margin-top:12px; }
  th, td{ border:1px solid #e1eefb; padding:8px; text-align:left; font-size:13px; vertical-align:middle; }
  th{ background:#f4fbff; color:var(--blue); font-weight:800; }
  @media (max-width:980px){ .form-grid{ grid-template-columns: repeat(2, 1fr); } .entry-row{ flex-wrap:wrap; } }
  @media (max-width:600px){ .form-grid{ grid-template-columns: 1fr; } .entry-row{ flex-direction:column; align-items:stretch; } }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="top-left">
      <div class="company">SSME71</div>
      <div class="erp-menu">ERP Menu</div>
    </div>
    <div class="top-center"><div class="menu-title">Buffing Production</div></div>
    <div class="top-right">
      <div class="search-box" title="Search menu">
        <input id="menuSearch" type="search" placeholder="Search" aria-label="Menu search">
        <button id="menuSearchBtn" aria-label="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
      </div>
      <div class="user-area">(User : store)</div>
      <div class="change-user">Change User</div>
    </div>
  </header>
<div class="wrap">
  <div class="panel" id="entryPanel">
    <h2>Buffing Production Sheet</h2>
    <div class="form-grid" id="headerForm">
      <div>
        <label>Date</label>
        <input id="hdr_date" type="date">
      </div>
      <div>
        <label>Part Code</label>
        <input id="hdr_part_code" type="text" placeholder="Part Code">
      </div>
      <div>
        <label>Part Description</label>
        <input id="hdr_part_description" type="text" placeholder="Part Description">
      </div>
    </div>
    <div class="controls" style="margin-top:8px;">
      <button class="btn ghost" id="addRowBtn"><i class="fa-solid fa-plus"></i> Add Row</button>
      <button class="btn ghost" id="clearRowsBtn"><i class="fa-solid fa-trash"></i> Clear Rows</button>
      <div style="flex:1"></div>
      <button class="btn primary" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Save All Rows</button>
      <button class="btn ghost" id="previewBtn"><i class="fa-regular fa-eye"></i> Preview</button>
    </div>
    <div id="entriesContainer" aria-live="polite"></div>
  </div>
  <div class="panel" style="margin-top:16px;">
    <h2>Download & Export</h2>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <label style="font-weight:700; color:var(--blue);">From:</label>
      <input type="date" id="fromDate" />
      <label style="font-weight:700; color:var(--blue);">To:</label>
      <input type="date" id="toDate" />
      <button class="btn ghost" id="loadBtn">Load Data</button>
      <button class="btn ghost" id="exportExcel">Export Excel</button>
      <button class="btn ghost" id="exportPDF">Export PDF</button>
      <div style="flex:1"></div>
    </div>
    <div id="monthResult" style="overflow-x:auto; max-width:100%; margin-top:12px;">
      <div class="small">No data loaded.</div>
    </div>
  </div>
</div>
<script>
const STORAGE_KEY = 'buffing_records_v2_fixed';
const entriesContainer = document.getElementById('entriesContainer');
const addRowBtn = document.getElementById('addRowBtn');
const clearRowsBtn = document.getElementById('clearRowsBtn');
const saveBtn = document.getElementById('saveBtn');
const previewBtn = document.getElementById('previewBtn');
const loadBtn = document.getElementById('loadBtn');
const exportExcelBtn = document.getElementById('exportExcel');
const exportPDFBtn = document.getElementById('exportPDF');
const menuSearch = document.getElementById('menuSearch');
const menuSearchBtn = document.getElementById('menuSearchBtn');
const rowColumns = [
  'lot_qty','ok_qty','ng_qty','reason_for_ng',
  'operator','incharge','remark'
];
function makeInput(type, cls, value, placeholder, options){
  let el;
  if (type === 'select'){
    el = document.createElement('select');
    (options||[]).forEach(opt => { const o = document.createElement('option'); o.value = opt.value; o.text = opt.label; el.appendChild(o); });
    el.value = value || '';
  } else {
    el = document.createElement('input'); el.type = type || 'text'; if (value !== undefined && value !== null) el.value = value; if (placeholder) el.placeholder = placeholder;
  }
  if (cls) el.classList.add(cls);
  el.addEventListener('keydown', navKeyHandler);
  return el;
}
function createRowElement(prefill = {}){
  const row = document.createElement('div'); row.className = 'entry-row';
  row.appendChild(makeInput('number','very-small', prefill['lot_qty'] ?? '', 'Lot Qty'));
  row.appendChild(makeInput('number','very-small', prefill['ok_qty'] ?? '', 'Ok Qty'));
  row.appendChild(makeInput('number','very-small', prefill['ng_qty'] ?? '', 'NG Qty'));
  row.appendChild(makeInput('text','small', prefill['reason_for_ng'] ?? '', 'Reason for NG'));
  row.appendChild(makeInput('text','small', prefill['operator'] ?? '', 'Operator'));
  row.appendChild(makeInput('text','small', prefill['incharge'] ?? '', 'Incharge'));
  row.appendChild(makeInput('text','small', prefill['remark'] ?? '', 'Remark'));
  const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.className='btn warn action-btn'; delBtn.title='Remove row'; delBtn.innerHTML='<i class="fa-solid fa-trash"></i>';
  delBtn.addEventListener('click', () => { row.remove(); updateNavInputs(); });
  row.appendChild(delBtn);
  return row;
}
function addRow(prefill = {}){ const el = createRowElement(prefill); entriesContainer.appendChild(el); updateNavInputs(); const inputs = el.querySelectorAll('input, select'); if (inputs[0]) inputs[0].focus(); }
addRow();
addRowBtn.addEventListener('click', () => addRow());
clearRowsBtn.addEventListener('click', () => { if (!confirm('Clear all entry rows?')) return; entriesContainer.innerHTML = ''; addRow(); });
function collectNavInputs(){ return Array.from(entriesContainer.querySelectorAll('input, select')); }
function navKeyHandler(e){ const inputs = collectNavInputs(); const idx = inputs.indexOf(e.target); if (e.key === 'ArrowRight'){ e.preventDefault(); if (idx>=0 && idx < inputs.length-1) inputs[idx+1].focus(); } else if (e.key === 'ArrowLeft'){ e.preventDefault(); if (idx>0) inputs[idx-1].focus(); } else if (e.key === 'Enter'){ e.preventDefault(); if (idx>=0 && idx < inputs.length-1) inputs[idx+1].focus(); } }
function updateNavInputs(){ const inputs = collectNavInputs(); inputs.forEach(inp => { inp.removeEventListener('keydown', navKeyHandler); inp.addEventListener('keydown', navKeyHandler); }); }
window.updateNavInputs = updateNavInputs;
function readEntriesFromStorage(){ const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return []; try { return JSON.parse(raw) || []; } catch(e){ return []; } }
function writeEntriesToStorage(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
saveBtn.addEventListener('click', async () => {
  const headerDate = document.getElementById('hdr_date').value;
  if (!headerDate) { alert('Select Date in header before saving.'); return; }
  const headerPartCode = document.getElementById('hdr_part_code').value || '';
  const headerPartDescription = document.getElementById('hdr_part_description').value || '';
  const rows = Array.from(entriesContainer.querySelectorAll('.entry-row'));
  if (!rows.length) { alert('No rows to save.'); return; }
  const toSave = [];
  for (let r of rows) {
    const inputs = Array.from(r.querySelectorAll('input, select'));
    let i = 0;
    const entry = {
      date: headerDate,
      part_code: headerPartCode,
      part_description: headerPartDescription,
      lot_qty: parseInt(inputs[i++].value) || null,
      ok_qty: parseInt(inputs[i++].value) || null,
      ng_qty: parseInt(inputs[i++].value) || null,
      reason_for_ng: inputs[i++].value || null,
      operator: inputs[i++].value || null,
      incharge: inputs[i++].value || null,
      remark: inputs[i++].value || null,
      savedAt: new Date().toISOString()
    };
    toSave.push(entry);
    try {
      let res = await fetch("/api/buffing-entries/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      });
      if (!res.ok) throw new Error("API error");
    } catch (err) {
      console.error("Save failed:", err);
      alert("Error while saving to server.");
      return;
    }
  }
  const stored = readEntriesFromStorage();
  stored.push(...toSave);
  writeEntriesToStorage(stored);
  alert(`Saved ${toSave.length} row(s) to server + localStorage!`);
});
function buildTableHtml(entries){
  if (!entries.length) return '<div class="small">No records.</div>';
  let html = '<table id="dataTable"><thead><tr>';
  const heads = [
    'Date','Part Code','Part Description','Lot Qty','OK Qty',
    'NG Qty','Reason for NG','Operator','Incharge','Remark'
  ];
  heads.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
  html += '</tr></thead><tbody>';
  
  entries.forEach(en => {
    html += '<tr>';
    const row = [
      en.date || '',
      en.part_code || '',        
      en.part_description || '',        
      en.lot_qty || '',
      en.ok_qty || '',
      en.ng_qty || '',
      en.reason_for_ng || '',
      en.operator || '',
      en.incharge || '',
      en.remark || '',
    ];
    row.forEach(c => html += `<td>${escapeHtml(c)}</td>`);
  });

  html += '</tbody></table>';
  return html;
}
async function loadDataFromAPI() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    if (!fromDate || !toDate) { alert("Please select both From and To dates"); return; }
    try {
        let res = await fetch("/api/buffing-entries/");
        let data = await res.json();
        let filtered = data.filter(e => e.date >= fromDate && e.date <= toDate);
        document.getElementById('monthResult').innerHTML = buildTableHtml(filtered);
    } catch (err) {
        console.error("Load failed:", err);
        alert("Error while loading data.");
    }
}
loadBtn.addEventListener('click', loadDataFromAPI);
/* Attach search functionality (menuSearch) */
if (menuSearch){ menuSearch.addEventListener('keyup', function(){ const q = this.value.toLowerCase(); const table = document.getElementById('dataTable'); if (!table) return; const rows = table.querySelectorAll('tbody tr'); rows.forEach(r => { const text = r.innerText.toLowerCase(); r.style.display = text.includes(q) ? '' : 'none'; }); }); }
if (menuSearchBtn){ menuSearchBtn.addEventListener('click', function(){ if (menuSearch) menuSearch.dispatchEvent(new Event('keyup')); }); }
/* Export handlers for range */
exportExcelBtn.addEventListener('click', () => {
  const fromDate = document.getElementById('fromDate').value; const toDate = document.getElementById('toDate').value; if (!fromDate || !toDate){ alert('Select From & To dates'); return; }
  const entries = readEntriesFromStorage().filter(e => e.date && e.date >= fromDate && e.date <= toDate);
  if (!entries.length) { alert('No records in range'); return; }
  exportEntriesToExcel(entries, `${fromDate}_to_${toDate}`);
});
exportPDFBtn.addEventListener('click', () => {
  const fromDate = document.getElementById('fromDate').value; const toDate = document.getElementById('toDate').value; if (!fromDate || !toDate){ alert('Select From & To dates'); return; }
  const entries = readEntriesFromStorage().filter(e => e.date && e.date >= fromDate && e.date <= toDate);
  if (!entries.length) { alert('No records in range'); return; }
  exportEntriesToPDF(entries, `${fromDate}_to_${toDate}`);
});
/* Month exports */
document.getElementById('exportMonthExcel').addEventListener('click', function(){ const m = document.getElementById('monthPicker').value; if (!m) { alert('Pick a month first'); return; } const entries = readEntriesFromStorage().filter(e => e.date && e.date.slice(0,7) === m); if (!entries.length) { alert('No records for this month'); return; } exportEntriesToExcel(entries, m); });
document.getElementById('exportMonthPDF').addEventListener('click', function(){ const m = document.getElementById('monthPicker').value; if (!m) { alert('Pick a month first'); return; } const entries = readEntriesFromStorage().filter(e => e.date && e.date.slice(0,7) === m); if (!entries.length) { alert('No records for this month'); return; } exportEntriesToPDF(entries, m); });
/* delete/clear */
function deleteEntry(savedAt){ if (!confirm('Delete this single entry?')) return; const remaining = readEntriesFromStorage().filter(e => e.savedAt !== savedAt); writeEntriesToStorage(remaining); alert('Deleted'); document.getElementById('monthResult').innerHTML = '<div class="small">Entry deleted. Reload range to refresh.</div>'; }
document.getElementById('clearAllData').addEventListener('click', function(){ if (!confirm('Delete ALL saved records from this browser? This cannot be undone.')) return; localStorage.removeItem(STORAGE_KEY); document.getElementById('monthResult').innerHTML = '<div class="small">All records removed.</div>'; });
function exportEntriesToExcel(entries, filenamePrefix) {
  const aoa = [];
  aoa.push(["Sri Sai Markers & Engravers"]);
  aoa.push(["Buffing Production Sheet"]);
  aoa.push([]);
  const table = document.getElementById("dataTable");
  if (!table) return alert("No table available!");
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wsTable = XLSX.utils.table_to_sheet(table);
  XLSX.utils.sheet_add_json(ws, XLSX.utils.sheet_to_json(wsTable), { origin: -1 });
  XLSX.utils.book_append_sheet(wb, ws, "Buffing Records");
  XLSX.writeFile(wb, `BuffingRecords.xlsx`);
}
function exportEntriesToPDF(filenamePrefix) {
  const table = document.getElementById("dataTable");
  if (!table) return alert("No table available!");
  const headers = [];
  table.querySelectorAll("thead th").forEach(th => headers.push(th.innerText));
  const body = [];
  table.querySelectorAll("tbody tr").forEach(tr => {
    const row = [];
    tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
    body.push(row);
  });
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("l", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 8;
  const boxX = margin;
  const boxY = margin;
  const boxWidth = pageWidth - margin * 2;
  const boxHeight = pageHeight - margin * 2;
  pdf.setDrawColor(0); 
  pdf.setLineWidth(0.5);
  pdf.rect(boxX, boxY, boxWidth, boxHeight);
  const logo = new Image();
  logo.src = "/static/logo.png"; 
  logo.onload = function () {
    const imgWidth = 18;
    const imgHeight = 18;
    const imgX = boxX + 5;
    const imgY = boxY + 5;
    pdf.addImage(logo, "PNG", imgX, imgY, imgWidth, imgHeight);
  pdf.setFontSize(16);
  pdf.text("Sri Sai Markers & Engravers", pageWidth / 2, boxY + 10, { align: "center" });
  pdf.setFontSize(10);
  pdf.text("Buffing Production Sheet", pageWidth / 2, boxY + 18, { align: "center" });
  pdf.autoTable({
    startY: boxY + 25,
    head: [headers],
    body: body,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [43, 110, 163], textColor: 255 },
    theme: "grid",
    margin: { left: boxX + 2, right: margin + 2 },
  });
  pdf.save(`BuffingRecords.pdf`);
};
}
function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
/* init */
(function init(){ const now = new Date(); const mm = now.toISOString().slice(0,7); const monthPicker = document.getElementById('monthPicker'); if (monthPicker) monthPicker.value = mm; const from = new Date(now.getFullYear(), now.getMonth(), 1); const to = new Date(now.getFullYear(), now.getMonth()+1, 0); document.getElementById('fromDate').value = from.toISOString().slice(0,10); document.getElementById('toDate').value = to.toISOString().slice(0,10); updateNavInputs(); })();
</script>
</body>
</html>